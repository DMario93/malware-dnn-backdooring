import os
import logging
import sys

from defenses.sanitization.disassembler import mask_binary

logger = logging.getLogger("sanitizer")
logger.setLevel(logging.INFO)


def sanitize_binaries(input_dir, percentage_to_mask, output_dir):
    for binary in os.scandir(input_dir):
        mask_binary(binary, percentage_to_mask, output_dir)
        logging.info(f"sanitized {binary.name}")


def sanitize_increasing_percentage(goodware_dir, malware_dir, triggered_dir, output_dir):
    for percentage in [.1, .2, .3, .4, .5, .6]:
        output_dir_percentage = os.path.join(output_dir, f"{int(percentage * 100)}")
        goodware_output_dir = os.path.join(output_dir_percentage, "goodware")
        malware_output_dir = os.path.join(output_dir, "malware")
        triggered_output_dir = os.path.join(output_dir, "triggered")

        sanitize_binaries(goodware_dir, percentage, goodware_output_dir)
        sanitize_binaries(malware_dir, percentage, malware_output_dir)
        sanitize_binaries(triggered_dir, percentage, triggered_output_dir)


if __name__ == '__main__':
    goodware_dir_ = sys.argv[1]
    malware_dir_ = sys.argv[2]
    triggered_dir_ = sys.argv[3]
    output_dir_ = sys.argv[4]
    sanitize_increasing_percentage(goodware_dir_, malware_dir_, triggered_dir_, output_dir_)
