import os
import logging

import pefile


logger = logging.getLogger("patcher")
logger.setLevel(logging.INFO)


def patch_binary(binary_path, modifications, binary_data=None, output_dir=None):
    try:
        if binary_data:
            pe_reader = pefile.PE(data=binary_data)
        else:
            pe_reader = pefile.PE(binary_path)
        for start_address, end_address, modification in modifications:
            pe_reader.set_bytes_at_offset(start_address, modification)
        file_data = pe_reader.write()
        if output_dir:
            output_file = os.path.join(output_dir, os.path.basename(binary_path))
            with open(output_file, 'wb') as outfile:
                outfile.write(bytes(file_data))
            logger.info(f"patched {binary_path}")
        else:
            return bytes(file_data)
    except pefile.PEFormatError:
        pass
    except AttributeError as e:
        logger.error(e)
    except FileNotFoundError as e:
        logger.error(e)

